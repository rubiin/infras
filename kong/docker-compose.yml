version: '3.5'

services:
    kong-database:
        container_name: kong-database
        image: postgres:9.6-alpine
        networks:
        - orbis-net
        ports:
        - 4084:5432
        env_file:
            - "./env/${ENV}.env"
        volumes:
        - "kong_persist_volume:/var/lib/postgresql/data"
        healthcheck:
            test: ["CMD", "pg_isready", "-U", "postgres"]
            interval: 5s
            timeout: 5s
            retries: 5
        restart: unless-stopped

    #######################################
    # Kong database migration
    #######################################
    kong-migration:
        container_name: kong-migration
        image: rosebay-kong:latest
        build:
            context: .
        networks:
        - orbis-net
        depends_on:
        - kong-database
        env_file:
        - "./env/${ENV}.env"
        links:
        - kong-database
        command: kong migrations bootstrap
        restart: on-failure

    #######################################
    # Kong: The API Gateway
    #######################################
    kong:
        container_name: kong
        image: rosebay-kong:latest
        build:
            context: .
        networks:
        - orbis-net
        depends_on:
        - kong-database
        - kong-migration
        env_file:
            - "./env/${ENV}.env"
        expose:
        - 8000
        - 8001
        - 8443
        - 8444
        ports:
        - "4050:8000"
        - "4052:8443"
        healthcheck:
            #test: ["CMD-SHELL", "curl -I -s -L http://127.0.0.1:8000 || exit 1"]
            test: ["CMD", "curl", "-f", "http://kong:8001"]
            interval: 5s
            timeout: 2s
            retries: 10
        restart: unless-stopped

    #######################################
    # Konga database prepare
    #######################################
    konga-prepare:
        container_name: konga-prepare
        image: pantsel/konga:next
        command: "-c prepare -a postgres -u postgresql://kong:i6%213gV%2F%218aXV-q@kong-database:5432/konga_db"
        networks:
        - orbis-net
        restart: on-failure
        links:
        - kong-database
        depends_on:
        - kong-database

    #######################################
    # Konga: Kong GUI
    #######################################
    konga:
        container_name: konga
        image: pantsel/konga:next
        restart: unless-stopped
        networks:
        - orbis-net
        volumes:
        - ./konga_users.js:/app/user_seed.js:ro
        env:
        - "env/${ENV}.env"
        depends_on:
        - kong-database
        ports:
        - "4051:1337"
networks:
        orbis-net:
            name: orbis-network
            ipam:
                driver: default
                config:
                    - subnet: "172.16.238.0/24"
                    - subnet: "2001:3984:3989::/64"
volumes:
        kong_persist_volume:
